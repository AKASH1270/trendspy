<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trendspy — Product</title>

<!-- small helper lib for touch swipe (optional but nice) -->
<style>
:root{
  --bg:#0b0f1e;
  --card:rgba(255,255,255,0.06);
  --accent:#ec4899;
  --accent2:#8b5cf6;
  --muted:#94a3b8;
  --text:#f5f5f5;
}
body{margin:0;font-family:'Poppins',sans-serif;background:radial-gradient(circle at top,#1a1035,#0b0f1e 85%);color:var(--text);transition:background .3s,color .3s}
body.light{background:linear-gradient(180deg,#f9fafb,#e5e7eb);color:#111827}
.container{max-width:1100px;margin:24px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.brand{font-weight:700;font-size:20px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.controls{display:flex;gap:10px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12)}
.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;box-shadow:0 6px 18px rgba(236,72,153,0.12)}
.layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
@media (max-width:900px){ .layout{grid-template-columns:1fr;}}
.card{background:var(--card);border-radius:12px;padding:14px}
.gallery{display:flex;flex-direction:column;gap:10px}
.main-slide{position:relative;border-radius:10px;overflow:hidden;background:#111}
.main-slide img{width:100%;height:420px;object-fit:contain;display:block;background:#0b0f1e}
@media (max-width:600px){ .main-slide img{height:320px} }
.thumbs{display:flex;gap:10px;overflow-x:auto;padding:6px 2px}
.thumb{min-width:80px;height:80px;border-radius:8px;overflow:hidden;cursor:pointer;flex-shrink:0;border:2px solid transparent}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.thumb.active{border-color:var(--accent)}
.info h1{font-size:20px;margin:0 0 8px 0}
.price{font-size:18px;font-weight:700;margin:8px 0}
.meta{color:var(--muted);margin-bottom:10px}
.qty-row{display:flex;align-items:center;gap:10px;margin:12px 0}
.qty-btn{width:34px;height:34px;border-radius:8px;border:none;background:rgba(255,255,255,0.06);font-weight:700;cursor:pointer}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.desc{margin-top:12px;color:var(--muted);line-height:1.5}
.back-link{color:var(--muted);cursor:pointer;text-decoration:underline}
.small{font-size:13px;color:var(--muted)}
/* theme adjustments for light */
body.light .card{background:#fff;color:var(--text)}
body.light .ghost{border-color:rgba(0,0,0,0.08)}
/* swipe indicator */
.swipe-hint{font-size:12px;color:var(--muted);margin-top:6px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">Trendspy</div>
    <div class="controls">
      <button class="btn ghost" id="backBtn">← Back</button>
      <div style="width:8px"></div>
      <label style="display:flex;align-items:center;gap:8px">
        <input id="themeSwitch" type="checkbox" style="display:none">
        <span id="themeLabel" style="font-weight:600">Dark</span>
      </label>
    </div>
  </div>

  <div class="layout">
    <!-- Gallery -->
    <div class="card gallery">
      <div class="main-slide" id="mainSlide">
        <img id="mainImage" src="" alt="product image">
      </div>
      <div class="thumbs" id="thumbs"></div>
      <div class="swipe-hint">Swipe images → (or click thumbnails)</div>
    </div>

    <!-- Info -->
    <div class="card info">
      <h1 id="title">Loading...</h1>
      <div class="meta small" id="cat">Category • —</div>
      <div class="price" id="price">₹0</div>

      <div class="desc" id="shortDesc">Loading description...</div>

      <div class="qty-row">
        <div style="display:flex;align-items:center;gap:8px">
          <button class="qty-btn" id="decQty">-</button>
          <div id="qtyVal" style="min-width:26px;text-align:center;">1</div>
          <button class="qty-btn" id="incQty">+</button>
        </div>
        <div style="flex:1"></div>
        <div class="small">Delivery in 3–7 days</div>
      </div>

      <div class="actions">
        <button class="btn primary" id="addToCartBtn">Add to Cart</button>
        <button class="btn ghost" id="buyNowBtn">Buy Now</button>
        <button class="btn ghost" id="wishlistBtn">♡ Wishlist</button>
      </div>

      <div style="margin-top:14px">
        <div class="small"><b>SKU:</b> <span id="sku">—</span></div>
        <div class="small" id="stockInfo" style="margin-top:6px"></div>
      </div>

      <div style="margin-top:16px">
        <h4 style="margin:0 0 8px 0">Product Details</h4>
        <div class="desc" id="longDesc"></div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase + Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "trendspy-3ba6d.firebaseapp.com",
  databaseURL: "https://trendspy-3ba6d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "trendspy-3ba6d",
  storageBucket: "trendspy-3ba6d.appspot.com",
  messagingSenderId: "1064401414241",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $ = id => document.getElementById(id);

let product = null;
let qty = 1;
let gallery = [];

/* theme sync */
(function initTheme(){
  const theme = localStorage.getItem('theme');
  if(theme === 'light'){ document.body.classList.add('light'); $('themeSwitch').checked = true; $('themeLabel').textContent = 'Light'; }
  $('themeSwitch').onchange = ()=>{
    const on = $('themeSwitch').checked;
    document.body.classList.toggle('light', on);
    $('themeLabel').textContent = on ? 'Light' : 'Dark';
    localStorage.setItem('theme', on ? 'light' : 'dark');
  };
})();

/* utils */
function toast(msg){ alert(msg); }
function getParam(name){ return new URLSearchParams(window.location.search).get(name); }

/* load product */
async function loadProduct(){
  const id = getParam('id');
  if(!id){ $('title').textContent = "Product not found"; return; }
  // try direct path first (common structure in our project)
  let snap = await get(child(ref(db), `products/${id}`));
  if(!snap.exists()){
    // try scanning products to find matching id property
    const all = await get(child(ref(db), 'products'));
    if(all.exists()){
      const arr = Object.values(all.val());
      const found = arr.find(p => String(p.id) === String(id));
      if(found) product = found;
    }
  } else {
    product = snap.val();
  }

  if(!product){
    // fallback: show minimal info
    $('title').textContent = "Product not found";
    $('shortDesc').textContent = "This product doesn't exist in database.";
    return;
  }

  // build gallery: if product.images array exists use it otherwise build from product.image + placeholders
  if(Array.isArray(product.images) && product.images.length) gallery = product.images.slice();
  else {
    gallery = [];
    if(product.image) gallery.push(product.image);
    // add a couple of placeholders if only one image (keeps UI nice)
    gallery.push("https://picsum.photos/800/600?random=21");
    gallery.push("https://picsum.photos/800/600?random=31");
    // ensure unique
    gallery = [...new Set(gallery)].slice(0,6);
  }

  renderGallery();
  renderInfo();
}

/* render gallery */
function renderGallery(){
  const main = $('mainImage');
  const thumbs = $('thumbs');
  thumbs.innerHTML = '';
  gallery.forEach((src, idx) => {
    const t = document.createElement('div');
    t.className = 'thumb' + (idx===0 ? ' active' : '');
    t.innerHTML = `<img src="${src}" alt="thumb${idx}">`;
    t.addEventListener('click', (e)=>{
      setMain(idx);
    });
    thumbs.appendChild(t);
  });
  setMain(0);
  enableSwipe();
}

/* set main image and active thumb */
function setMain(index){
  index = Math.max(0, Math.min(index, gallery.length-1));
  $('mainImage').src = gallery[index];
  Array.from($('thumbs').children).forEach((c,i)=> c.classList.toggle('active', i===index));
  // store current index on main element
  $('mainImage').dataset.index = index;
}

/* enable horizontal swipe on mainSlide */
function enableSwipe(){
  const slide = document.getElementById('mainSlide');
  let startX=0, cur=0, dragging=false;

  slide.addEventListener('touchstart', e=>{
    dragging=true; startX = e.touches[0].clientX;
  }, {passive:true});
  slide.addEventListener('touchmove', e=>{
    if(!dragging) return;
    cur = e.touches[0].clientX;
  }, {passive:true});
  slide.addEventListener('touchend', e=>{
    if(!dragging) return;
    dragging=false;
    const delta = cur - startX;
    if(Math.abs(delta) < 30) return;
    const idx = parseInt($('mainImage').dataset.index || 0);
    if(delta < 0) setMain(idx + 1);
    else setMain(idx - 1);
  });
}

/* render main product info */
function renderInfo(){
  $('title').textContent = product.title || 'Product';
  $('price').textContent = '₹' + (product.price || 0);
  $('shortDesc').textContent = product.shortDescription || (product.title || '');
  $('longDesc').innerHTML = product.longDescription ? product.longDescription : (product.description || 'No additional details available.');
  $('cat').textContent = (product.category || 'General') + ' • ' + (product.brand || '');
  $('sku').textContent = product.sku || (product.id || '—');
  $('stockInfo').textContent = product.stock ? (product.stock + " in stock") : "Stock info not available";
}

/* quantity controls */
$('incQty').addEventListener('click', ()=>{ qty++; $('qtyVal').textContent = qty; });
$('decQty').addEventListener('click', ()=>{ if(qty>1) qty--; $('qtyVal').textContent = qty; });

/* Back button */
$('backBtn').addEventListener('click', ()=> {
  if(document.referrer && document.referrer.includes(location.hostname)) history.back();
  else window.location.href = 'index.html';
});

/* Cart integration (localStorage) */
function getCart(){ return JSON.parse(localStorage.getItem('cart') || '{}'); }
function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }

/* Add to cart */
$('addToCartBtn').addEventListener('click', ()=>{
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  if(!user){ toast('Please login first!'); return; }

  const c = getCart();
  const pid = product.id || (product && product.id) || ('p' + Date.now());
  if(!c[pid]) c[pid] = { id: pid, title: product.title, price: product.price, image: gallery[0], qty: 0 };
  c[pid].qty += qty;
  saveCart(c);
  toast('Added to cart');
  // update floating cart badge if available (index page)
  try{ window.opener?.postMessage?.({type:'cartUpdated'}, '*'); } catch(e){}
});

/* Buy Now — create currentOrder and go to payment */
$('buyNowBtn').addEventListener('click', ()=>{
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  if(!user){ toast('Please login first!'); return; }
  // create a single-item currentOrder
  const order = {
    id: 'ORD' + Date.now(),
    user: user.name,
    contact: user.contact,
    items: {},
    total: '₹' + (product.price * qty),
    status: 'Pending',
    trackingStage: 0,
    ts: new Date().toLocaleString()
  };
  const pid = product.id || ('p' + Date.now());
  order.items[pid] = { id: pid, title: product.title, price: product.price, qty: qty, image: gallery[0] };

  localStorage.setItem('currentOrder', JSON.stringify(order));
  window.location.href = 'payment.html';
});

/* wishlist stub */
$('wishlistBtn').addEventListener('click', ()=>{
  toast('Added to wishlist (demo)');
});

/* load */
loadProduct();
</script>
</body>
</html>
