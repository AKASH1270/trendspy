<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trendspy ‚Äî Admin Dashboard (PRO)</title>

<!-- Charts + Utilities -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
/* ===== Trendspy PRO Admin (Sidebar Layout) ===== */
:root{
  --bg: #070813;
  --panel: rgba(255,255,255,0.04);
  --muted: #94a3b8;
  --text: #e6edf3;
  --accent: #ec4899;
  --accent2: #8b5cf6;
  --success: #22c55e;
  --danger: #ef4444;
  --glass: rgba(255,255,255,0.03);
  --sidebar-w: 260px;
  font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Light theme overrides */
body.light{
  --bg:#f6f7fb;
  --panel:#ffffff;
  --muted:#64748b;
  --text:#0f172a;
  --glass: rgba(0,0,0,0.04);
}

/* Layout base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#05060a 0%, #0b0f1e 100%);color:var(--text)}
body{background:var(--bg);transition:background .25s,color .25s}

/* App shell */
.app {
  display:flex;
  min-height:100vh;
  gap:24px;
}

/* Sidebar */
.sidebar {
  width:var(--sidebar-w);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-right:1px solid rgba(255,255,255,0.04);
  padding:20px 16px;
  display:flex;
  flex-direction:column;
  gap:18px;
  position:sticky;
  top:0;
  height:100vh;
}
.logo-block{
  display:flex;align-items:center;gap:12px;
}
.logo-mark{
  width:44px;height:44px;border-radius:10px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:20px;
  box-shadow:0 6px 18px rgba(139,92,246,0.12);
}
.brand-title{font-weight:800;font-size:16px}
.brand-sub{font-size:12px;color:var(--muted)}

/* Nav */
.side-nav{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.side-nav a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:var(--muted);text-decoration:none;font-weight:600}
.side-nav a.active, .side-nav a:hover{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;box-shadow:0 8px 30px rgba(140, 50, 180, 0.08)}

/* Small utility row */
.side-utilities{margin-top:auto;display:flex;flex-direction:column;gap:8px}
.small-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer;font-weight:700}
.small-btn:hover{background:var(--glass)}

/* Main content */
.main {
  flex:1;padding:18px 22px 40px;display:flex;flex-direction:column;gap:18px;
}

/* Topbar */
.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 6px 20px rgba(0,0,0,0.45);
}
.top-left{display:flex;align-items:center;gap:12px}
.search {
  display:flex;align-items:center;gap:8px;background:var(--panel);padding:8px;border-radius:10px;
  border:1px solid rgba(255,255,255,0.03);min-width:260px;
}
.search input{border:0;background:transparent;color:var(--text);outline:none;padding:6px;font-weight:600}
.top-actions{display:flex;align-items:center;gap:10px}

/* Status pill */
.db-pill{
  font-weight:700;padding:6px 10px;border-radius:12px;color:white;background:#ef4444;font-size:13px;
}

/* Cards grid */
.grid{
  display:grid;grid-template-columns:repeat(12,1fr);gap:14px;
}
.card{
  grid-column: span 4;
  background:var(--panel);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 6px 24px rgba(0,0,0,0.4);
}
.card.full{grid-column:1 / -1}
.card h3{margin:0;font-size:16px;color:var(--muted);font-weight:700}
.metric{font-size:20px;font-weight:800;margin-top:6px}

/* Orders list */
.orders-list{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:6px}
.order-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.02)}
.order-item small{color:var(--muted)}

/* Charts responsive */
canvas{width:100%!important;height:180px!important;border-radius:8px}

/* Footer */
.admin-footer{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}

/* Responsive behavior */
@media (max-width:1100px){
  :root{--sidebar-w:220px}
  .card{grid-column: span 6}
  .card.full{grid-column:1 / -1}
}
@media (max-width:820px){
  .app{flex-direction:column}
  .sidebar{width:100%;height:auto;position:relative;display:flex;flex-direction:row;align-items:center;padding:10px;gap:14px;overflow:auto}
  .side-nav{flex-direction:row;gap:8px}
  .side-utilities{display:none}
  .grid{grid-template-columns:repeat(6,1fr)}
  .card{grid-column: span 6}
  .search{min-width:160px}
}
@media (max-width:420px){
  .grid{grid-template-columns:repeat(1,1fr)}
  .card{grid-column:span 1}
  .search{min-width:120px}
}

/* tiny helpers */
.kv{display:flex;justify-content:space-between;align-items:center}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
</style>
</head>
<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Trendspy admin sidebar">
    <div class="logo-block">
      <div class="logo-mark">TS</div>
      <div>
        <div class="brand-title">Trendspy PRO</div>
        <div class="brand-sub">Admin Portal</div>
      </div>
    </div>

    <nav class="side-nav" role="navigation" aria-label="Main">
      <a href="shop.html" class="active">üìä Dashboard</a>
      <a href="import.html?auth=trendspy-admin">üõç Manage Products</a>
      <a href="orders.html">üì¶ Orders</a>
      <a href="customers.html">üë• Customers</a>
      <a href="reports.html">üìà Reports</a>
    </nav>

    <div class="side-utilities">
      <button id="manageProductsSide" class="small-btn">Manage Products</button>
      <div style="height:8px"></div>
      <button id="logoutSide" class="small-btn">Logout</button>
      <div style="height:6px"></div>
      <div style="font-size:12px;color:var(--muted)">Theme</div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="themeSwitch" />
          <div style="width:44px;height:22px;background:var(--glass);border-radius:999px;position:relative"></div>
        </label>
        <div style="font-weight:700;color:var(--muted)" id="themeLabel">Dark</div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- TOP BAR -->
    <div class="topbar">
      <div class="top-left">
        <div style="font-weight:800;font-size:18px">üßæ Trendspy Admin Dashboard</div>
        <div id="db-status" class="db-pill">Database: Connecting...</div>
      </div>

      <div class="top-actions">
        <div class="search">
          <input id="search" placeholder="Search orders, id or contact..." />
        </div>
        <select id="filterStatus" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);font-weight:700">
          <option value="all">All</option>
          <option value="Pending">Pending</option>
          <option value="Accepted">Accepted</option>
          <option value="Out for Delivery">Out for Delivery</option>
          <option value="Delivered">Delivered</option>
          <option value="Cancelled">Cancelled</option>
        </select>

        <button class="ghost" id="refresh" title="Refresh">üîÅ</button>
        <button class="danger" id="clear" title="Clear orders">üóë</button>
        <button class="primary" id="manageProducts">üõç Manage Products</button>
        <button class="ghost" id="logout">Logout</button>
      </div>
    </div>

    <!-- GRID -->
    <div class="grid" style="margin-top:12px">

      <div class="card">
        <h3>Status Overview</h3>
        <div class="kv" style="margin-top:8px">
          <div style="display:flex;gap:12px">
            <div style="min-width:120px">
              <div class="metric" id="pendingCount">‚Äî</div>
              <div style="color:var(--muted)">Pending</div>
            </div>
            <div style="min-width:120px">
              <div class="metric" id="acceptedCount">‚Äî</div>
              <div style="color:var(--muted)">Accepted</div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="color:var(--muted)">Last updated</div>
            <div id="lastUpdated" style="font-weight:700">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Quick Actions</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button class="primary" onclick="window.location.href='import.html?auth=trendspy-admin'">Import Products</button>
          <button class="ghost" id="openOrders">Open Orders</button>
          <button class="ghost" id="openReports">Open Reports</button>
        </div>
      </div>

      <div class="card">
        <h3>Orders (Realtime)</h3>
        <div class="orders-list" id="orders"></div>
      </div>

      <div class="card full">
        <h3>Analytics</h3>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px">
          <canvas id="statusChart"></canvas>
          <canvas id="revenueChart"></canvas>
          <canvas id="categoryChart"></canvas>
          <canvas id="trendChart"></canvas>
        </div>
      </div>

    </div>

    <div class="admin-footer">¬© 2025 Trendspy ‚Äî Admin Panel</div>
  </main>

</div>

<!-- Keep original JS functionality intact (only relocated in layout) -->
<script type="module">
/* ====== Unmodified business logic from previous admin file ====== */
/* (I preserved your original firebase + orders logic; only small DOM hookups adapt to new layout) */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, onValue, update, remove, set } 
  from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

document.addEventListener("DOMContentLoaded", () => {

const firebaseConfig = {
  apiKey: "YOUR_API_KEY", // üîπ Replace with actual key
  authDomain: "trendspy-3ba6d.firebaseapp.com",
  databaseURL: "https://trendspy-3ba6d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "trendspy-3ba6d",
  storageBucket: "trendspy-3ba6d.appspot.com",
  messagingSenderId: "1064401414241",
  appId: "YOUR_APP_ID" // üîπ Replace with actual appId
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbStatus = document.getElementById("db-status");

// üîç Connectivity Check
(async ()=>{
  try {
    const testRef = ref(db, "admin_connectivity_test");
    await set(testRef, { connected: true, time: new Date().toISOString() });
    console.log("‚úÖ Firebase Admin connected successfully!");
    dbStatus.textContent = "Database: Connected ‚úÖ";
    dbStatus.style.background = "#22c55e";
  } catch (err) {
    console.error("‚ùå Firebase connection failed:", err);
    dbStatus.textContent = "Database: Disconnected ‚ùå";
    dbStatus.style.background = "#ef4444";
    alert("‚ùå Firebase connection failed: " + err.message);
  }
})();

const el=id=>document.getElementById(id);
const trackingStages=['Pending','Accepted','Out for Delivery','Delivered'];
let orders=[], filteredOrders=[];
let charts={};

/* Toast */
function toast(m){
  const t=document.createElement('div');
  Object.assign(t.style,{position:'fixed',bottom:'16px',right:'16px',background:'rgba(0,0,0,0.75)',padding:'8px 12px',borderRadius:'8px',fontSize:'12px',zIndex:9999,color:'#fff'});
  t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),1500);
}

/* Theme Handling - keep behavior, update label */
const themeSwitch = document.getElementById('themeSwitch');
const themeLabel = document.getElementById('themeLabel');
if(localStorage.getItem('theme')==='light'){
  document.body.classList.add('light');
  themeSwitch.checked=true;
  themeLabel.textContent='Light';
}
themeSwitch.onchange=()=>{ document.body.classList.toggle('light',themeSwitch.checked); themeLabel.textContent=themeSwitch.checked?'Light':'Dark'; localStorage.setItem('theme',themeSwitch.checked?'light':'dark'); renderCharts(); };

/* Redirects & small UI hookups */
document.getElementById('manageProducts').onclick = ()=>{ toast("Redirecting to Product Management..."); setTimeout(()=>window.location.href="import.html?auth=trendspy-admin",700); };
document.getElementById('manageProductsSide').onclick = ()=> document.getElementById('manageProducts').click();
document.getElementById('logout').onclick = ()=> { toast("Logging out..."); setTimeout(()=>window.location.href='index.html',600); };
document.getElementById('logoutSide').onclick = ()=> document.getElementById('logout').click();
document.getElementById('openOrders').onclick = ()=> { window.location.href='orders.html'; };
document.getElementById('openReports').onclick = ()=> { window.location.href='reports.html'; };

/* Load Orders */
/* Load Orders */
function loadOrders() {
  const ordersRef = ref(db, 'orders');

  onValue(
    ordersRef,
    (snapshot) => {
      orders = [];
      let seenOrderIds = new Set();

      snapshot.forEach((user) => {
        user.forEach((order) => {
          const o = order.val();
          if (!seenOrderIds.has(o.id)) {
            seenOrderIds.add(o.id);
            orders.push(o);
          }
        });
      });

      filteredOrders = orders;
      renderOrders();
      renderCharts();

      el("lastUpdated").textContent = new Date().toLocaleString();

      // simple counts
      const counts = { Pending: 0, Accepted: 0 };
      orders.forEach((o) => {
        counts[o.status] = (counts[o.status] || 0) + 1;
      });

      el("pendingCount").textContent = counts["Pending"] || 0;
      el("acceptedCount").textContent = counts["Accepted"] || 0;
    },

    (err) => {
      console.error("Error loading orders:", err);
      dbStatus.textContent = "Database: Error ‚ùå";
      dbStatus.style.background = "#ef4444";
    }
  );
}


/* Render Orders */
function renderOrders(){
  const c = el('orders');
  c.innerHTML = '';

  if(!filteredOrders.length)
    return c.innerHTML = '<div style="color:var(--muted)">No orders found.</div>';

  // prevent duplicates by using a map keyed by id (safety)
  const seen = new Set();
  filteredOrders.slice().reverse().forEach(o=>{
    if(!o || !o.id) return;
    if(seen.has(o.id)) return; // skip duplicates
    seen.add(o.id);

    if(o.trackingStage === undefined) o.trackingStage = 0;

    const div = document.createElement('div');
    div.className = 'order-item';

    // top actions should be for top (primary) and secondary actions lower,
    // but original logic kept - we show buttons in item but prevent duplication of elements
    const remarkHtml = o.remark ? `<div style="font-size:12px;color:var(--muted);margin-top:6px"><b>Remark:</b> ${o.remark}</div>` : '';

    div.innerHTML = `
      <div style="max-width:78%">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="font-weight:800">${o.id}</div>
          <small style="color:var(--muted)">${o.ts || ''}</small>
        </div>
        <div style="margin-top:6px;color:var(--muted)">${o.user || ''} ‚Äî ${o.contact || ''} ‚Ä¢ ${o.total || ''}</div>
        ${remarkHtml}
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        ${
          o.status === "Cancelled"
            ? `<div style="color:var(--danger);font-weight:700">Cancelled</div>`
            : o.status === "Delivered"
              ? `<div style="color:var(--success);font-weight:700">Delivered</div>`
              : `<div style="display:flex;flex-direction:column;gap:6px">
                   <button class="primary" onclick="window.nextStage('${o.contact}','${o.id}')">Next</button>
                   ${ o.trackingStage > 0 ? `<button class="ghost" onclick="window.prevStage('${o.contact}','${o.id}')">Prev</button>` : '' }
                   <button class="ghost" onclick="window.cancelOrder('${o.contact}','${o.id}')">Cancel</button>
                 </div>`
        }
        <button class="ghost" onclick="window.location.href='order-details.html?id=${encodeURIComponent(o.id)}&contact=${encodeURIComponent(o.contact)}'">Details ‚Üí</button>
      </div>
    `;

    c.appendChild(div);
  });
}

/* Charts */
function renderCharts(){
  const isLight=document.body.classList.contains('light');
  const textColor=isLight?'#111827':'#fff';
  const gridColor=isLight?'#d1d5db':'#1e293b';
  const counts={Pending:0,Accepted:0,'Out for Delivery':0,Delivered:0,Cancelled:0};
  let daily={},monthly={},categories={};
  orders.forEach(o=>{
    counts[o.status]=(counts[o.status]||0)+1;
    if(o.status==='Delivered'){
      const amt=parseInt((o.total||'0').replace(/[‚Çπ,]/g,''))||0;
      const d=new Date(o.ts);
      const day=d.toLocaleDateString();
      const month=d.toLocaleString('default',{month:'short'});
      daily[day]=(daily[day]||0)+amt;
      monthly[month]=(monthly[month]||0)+amt;
      Object.values(o.items||{}).forEach(i=>{
        const cat=i.category||'Uncategorized';
        categories[cat]=(categories[cat]||0)+(i.qty||1);
      });
    }
  });
  Object.values(charts).forEach(ch=>ch.destroy?.());
  charts.status=new Chart(el('statusChart'),{type:'doughnut',data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts),backgroundColor:['#facc15','#ec4899','#8b5cf6','#22c55e','#ef4444']}]},options:{plugins:{legend:{labels:{color:textColor,boxWidth:12,font:{size:10}}}},cutout:'70%'}});
  charts.revenue=new Chart(el('revenueChart'),{type:'pie',data:{labels:Object.keys(monthly),datasets:[{data:Object.values(monthly),backgroundColor:['#22c55e','#3b82f6','#f97316','#ec4899','#a855f7','#14b8a6']}]},options:{plugins:{legend:{labels:{color:textColor,font:{size:10}}}}}});
  charts.category=new Chart(el('categoryChart'),{type:'bar',data:{labels:Object.keys(categories),datasets:[{label:'Units Sold',data:Object.values(categories),backgroundColor:'#8b5cf6'}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}},y:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}}}}});
  charts.trend=new Chart(el('trendChart'),{type:'line',data:{labels:Object.keys(daily),datasets:[{label:'Daily Revenue',data:Object.values(daily),borderColor:'#ec4899',tension:.4}]},options:{plugins:{legend:{labels:{color:textColor,font:{size:9}}}},scales:{x:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}},y:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}}}}});
}

/* Stage Control */
window.nextStage=async(contact,id)=>{const o=orders.find(x=>x.id===id);if(!o)return;if(o.trackingStage<trackingStages.length-1)o.trackingStage++;o.status=trackingStages[o.trackingStage];await update(ref(db,`orders/${contact}/${id}`),o);toast(`Moved to ${o.status}`);};
window.prevStage=async(contact,id)=>{const o=orders.find(x=>x.id===id);if(!o)return;if(o.trackingStage>0)o.trackingStage--;o.status=trackingStages[o.trackingStage];await update(ref(db,`orders/${contact}/${id}`),o);toast(`Reverted to ${o.status}`);};
window.cancelOrder=async(contact,id)=>{const o=orders.find(x=>x.id===id);if(!o)return;const reason=prompt("Reason for cancellation:","Out of stock");o.status='Cancelled';o.trackingStage=0;o.remark=reason;await update(ref(db,`orders/${contact}/${id}`),o);toast("Order cancelled.");};

/* Filters + Buttons */
el('search').addEventListener('input',filterOrders);
el('filterStatus').addEventListener('change',filterOrders);
function filterOrders(){
  const q=el('search').value.toLowerCase();
  const st=el('filterStatus').value;
  filteredOrders=orders.filter(o=>{
    const matchText=(o.user?.toLowerCase().includes(q)||o.contact?.toLowerCase().includes(q)||o.id?.toLowerCase().includes(q));
    const matchStatus=(st==='all'||o.status===st);
    return matchText&&matchStatus;
  });
  renderOrders();
}
el('refresh').onclick=()=>location.reload();
el('clear').onclick=async()=>{if(confirm("‚ö†Ô∏è Clear all orders?")){await remove(ref(db,'orders'));toast("Orders cleared!");}};
el('search').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') filterOrders(); });

/* Boot */
loadOrders();

}); // DOMContentLoaded
</script>
</body>
</html>
